{% assign total = 0 %}
{% assign lastyear = "0" %}
{% for row in data_table %}
  {% assign lastyear = year %}
  {% assign year = row.date | split: '-' | first %}
  {% if year != lastyear %}
    {% unless forloop.first %}
      <tr>
        <td></td>
        <td></td>
        <td></td>
        <td><strong>{{ year }} total spending</strong></td>
        <td><strong>£{{annual_total}}</strong></td>
      </tr>
      </table>
    {% endunless %}
    <h2>{{ year }}</h2>
    {% assign annual_total = 0 %}
    <table class='table table-striped'>
      <tr>
        <th>Date</th>
        <th>Buyer</th>
        <th>Supplier</th>
        <th>Description</th>
        <th>Total Paid</th>
      </tr>
  {% endif %}
  <tr>
    <td>{{row.date}}</td>
    <td>{% if row.buyer_uri and row.buyer_uri != "" %}<a href='{{row.buyer_uri}}'>{% endif %}{{row.buyer}}{% if row.buyer_uri and row.buyer_uri != "" %}</a>{% endif %}</td>
    <td>{% if row.supplier_uri and row.supplier_uri != "" %}<a href='{{row.supplier_uri}}'>{% endif %}{{row.supplier}}{% if row.supplier_uri and row.supplier_uri != "" %}</a>{% endif %}</td>
    <td><a href='http://www.unspsc.org/search-code/default.aspx?CSS={{row.unspsc_code}}'>{{row.description}}</a></td>
    <td>£{{row.total_paid}}</td>
    {% assign annual_total = annual_total | plus: row.total_paid %}
    {% assign total = total | plus: row.total_paid %}
  </tr>
  {% if forloop.last %}
    <tr>
      <td></td>
      <td></td>
      <td></td>
      <td><strong>{{ year }} total spending</strong></td>
      <td><strong>£{{annual_total}}</strong></td>
    </tr>
    </table>
  {% endif %}
{% endfor %}

<p>
  <strong>Overall Total Spending: £{{total}}</strong>
</p>
